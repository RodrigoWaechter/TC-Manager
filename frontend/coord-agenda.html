<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <!-- Bootstrap e ícones -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="css/styles.css" rel="stylesheet">
</head>

<body>
    <div class="container-pai">
        <!-- Topo com botões e usuário -->
        <div class="top-bar d-flex justify-content-between align-items-center mb-3">

            <!-- Botões principais -->
            <!-- Funciona o btn da tela atual fica azul e sem ação, enquanto q os outros, ao clicar, passam como paramentroa nova tela para abrir -->
            <div class="d-flex gap-2 flex-grow-1">
                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-gerenciar.html'">Gerenciar Usuários</button>

                <button type="button" class="btn btn-selected rounded-pill flex-fill">Definir Agenda</button>

                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-alunos.html'">Tabela Alunos</button>

                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-banca.html'">Tabela Banca</button>
            </div>

            <script>
                // Selecionar botão, com parametro de sua respectiva tela
                function selecionarBotao(botaoClicado) {
                    document.querySelectorAll('.top-bar .btn.rounded-pill').forEach(btn => {
                        btn.classList.replace('btn-selected', 'btn-primary');
                    });
                    botaoClicado.classList.replace('btn-primary', 'btn-selected');
                }
            </script>

            <!-- Calendário -->
            <div class="ms-2 position-relative">
                <input type="text" id="datepicker" class="form-control d-none">
                <button type="button" class="btn btn-primary rounded-circle" id="calendarBtn">
                    <i class="bi bi-calendar-event"></i>
                </button>
            </div>

            <!-- Usuário -->
            <div class="ms-3">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle d-flex align-items-center gap-2" type="button"
                        id="usuarioDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="nome-usuario">Carregando...</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="usuarioDropdown">
                        <li><a class="dropdown-item" href="#">Perfil</a></li>
                        <li><a class="dropdown-item" href="#">Configurações</a></li>
                        <li><a class="dropdown-item" href="#">Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Conteúdo principal -->
        <div id="conteudo">
            <table class="table table-bordered text-center align-middle">
                <thead>
                    <tr>
                        <th colspan="4" class="text-white text-start fs-5 bg-primary">Rastreador de Tarefas</th>
                    </tr>
                    <tr class="bg-info text-dark">
                        <th style="width: 35%;">Aluno</th>
                        <th style="width: 25%;">Orientador</th>
                        <th style="width: 20%;">Status</th>
                        <th style="width: 20%;">Banca</th>
                    </tr>
                </thead>
                <tbody id="tabela-agenda-body">
                    <tr>
                        <td colspan="4"></td>
                    </tr>
                    <tr>
                        <td colspan="4"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modal-gerenciar-banca" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalLabel">Gerenciar Banca</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="id-trabalho-modal">
                    
                    <h6>Membros da Banca</h6>
                    <div id="lista-professores-modal" class="mb-3 border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                        Carregando professores...
                    </div>

                    <h6>Agendamento</h6>
                    <div class="mb-3">
                        <label for="data-hora-banca" class="form-label">Data e Hora</label>
                        <input type="datetime-local" class="form-control" id="data-hora-banca">
                    </div>
                    <div class="mb-3">
                        <label for="local-banca" class="form-label">Local (Sala ou Link)</label>
                        <input type="text" class="form-control" id="local-banca" placeholder="Ex: Sala 302 ou Link do Meet">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-banca">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        // Calendário
        const fp = flatpickr("#datepicker", {
            onChange: (dates, dateStr) => console.log("Data selecionada:", dateStr),
            positionElement: document.getElementById('calendarBtn'),
            allowInput: true
        });
        document.getElementById('calendarBtn').addEventListener('click', () => fp.open());
    </script>

    <script>

        let bancaModal = null;
        let idTrabalhoAtual = null;

        document.addEventListener('DOMContentLoaded', () => {

            const modalEl = document.getElementById('modal-gerenciar-banca');
            if (modalEl) {
                bancaModal = new bootstrap.Modal(modalEl);
            }

            carregarNomeUsuario();
            carregarDadosAgenda();

            document.getElementById('btn-salvar-banca').addEventListener('click', salvarBanca);
        });

        function carregarNomeUsuario() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo'));
            const nomeUsuarioEl = document.getElementById('nome-usuario');

            if (userInfo && userInfo.nome) {
                nomeUsuarioEl.textContent = userInfo.nome;
            } else {
                nomeUsuarioEl.textContent = 'Usuário';
            }
        }

        async function carregarDadosAgenda() {
            const token = localStorage.getItem('authToken');
            const tbody = document.getElementById('tabela-agenda-body');

            tbody.innerHTML = '<tr><td colspan="4">Carregando dados...</td></tr>';

            // verificação de segurança: se não há token, redireciona para o login
            if (!token) {
                window.location.href = 'index.html'
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/coordenador/agenda', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // se token for inválido ou expirado
                if (!response.ok) {
                    // limpa o armazenamento e redireciona para o login
                    localStorage.clear();
                    window.location.href = 'index.html'
                    return;
                }

                const trabalhos = await response.json();

                // limpa a mensagem de "Carregando..."
                tbody.innerHTML = '';

                if (trabalhos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Nenhum trabalho encontrado.</td></tr>';
                } else {
                    trabalhos.forEach(trabalho => { 
                        const row = document.createElement('tr');

                        let infoBanca = '';
                        if (trabalho.membros_banca) {
                            const dataFormatada = new Date(trabalho.data_hora).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                            
                            infoBanca = `
                                <small>
                                    <strong>Membros:</strong> ${trabalho.membros_banca}<br>
                                    <strong>Data:</strong> ${dataFormatada}<br>
                                    <strong>Local:</strong> ${trabalho.local}
                                </small>
                            `;
                        } else { 
                            infoBanca = '<span class="text-muted">Não definida</span>';
                        }

                        row.innerHTML = `
                            <td>${trabalho.nome_aluno}</td>
                            <td>${trabalho.nome_orientador}</td>
                            <td><span class="badge bg-primary">${trabalho.status}</span></td>
                            <td>
                                ${infoBanca}
                                <hr class="my-1">
                                <button class="btn btn-info btn-sm gerenciar-banca-btn" data-id="${trabalho.id_trabalho}">
                                    <i class="bi bi-pencil-square"></i> Gerenciar
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.querySelectorAll('.gerenciar-banca-btn').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        const idTrabalho = event.currentTarget.dataset.id;
                        abrirModalGerenciarBanca(idTrabalho);
                    });
                });

            } catch (error) {
                console.error("Err oao buscar dados da agenda:", error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Falha ao carregar os dados. Verifique a conexão com o servidor.</td></tr>'
            }
        }

        async function abrirModalGerenciarBanca(idTrabalho) {
            idTrabalhoAtual = idTrabalho; // salva o ID do trabalho que está sendo editado
            const token = localStorage.getItem('authToken');
            const listaProfessoresDiv = document.getElementById('lista-professores-modal');
            listaProfessoresDiv.innerHTML = 'Carregando professores...';

            try {
                // busca a lista de todos os professores para preencher os checkboxes
                const response = await fetch('http://localhost:3000/professores', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { throw new Error('Falha ao buscar professores'); }
                
                const professores = await response.json();
                listaProfessoresDiv.innerHTML = '';

                professores.forEach(prof => {
                    listaProfessoresDiv.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${prof.id_usuario}" id="prof-${prof.id_usuario}">
                            <label class="form-check-label" for="prof-${prof.id_usuario}">
                                ${prof.nome}
                            </label>
                        </div>
                    `;
                });

                bancaModal.show();

            } catch(error) {
                listaProfessoresDiv.innerHTML = '<span class="text-danger">Erro ao carregar professores.</span>';
            }
        }

        async function salvarBanca() {
            const token = localStorage.getItem('authToken');
            const data_hora = document.getElementById('data-hora-banca').value;
            const local = document.getElementById('local-banca').value;
            
            const membrosSelecionados = [];
            document.querySelectorAll('#lista-professores-modal input[type="checkbox"]:checked').forEach(checkbox => {
                membrosSelecionados.push(checkbox.value);
            });

            if (!data_hora || !local || membrosSelecionados.length === 0) {
                alert('Por favor, preencha a data/hora, o local e selecione pelo menos um membro para a banca.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/coordenador/trabalhos/${idTrabalhoAtual}/definir-banca`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data_hora: data_hora,
                        local: local,
                        membros: membrosSelecionados
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'Erro ao salvar a banca.');
                }

                alert('Banca definida com sucesso!');
                bancaModal.hide();
                carregarDadosAgenda(); // recarrega a tabela principal com os novos dados

            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

    </script>

</body>

</html>