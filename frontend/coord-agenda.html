<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <style>
        /* --- Novo Estilo para a Tag de Tarefa --- */
        .tag-tarefa {
            background-color: #4a90e2;
            color: #ffffff;
            font-size: 0.75em;
            border-radius: 4px;
            white-space: normal;
            width: 90%;
        }

        #calendar {
            border: 1px solid #4a90e2;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;
            padding: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: #007bff;
            color: #ffffff;
            font-weight: 900;
            border-bottom: 1px solid #3a4669;
            border-radius: 5px 5px 0 0;
            text-transform: capitalize;
        }

        .header button {
            background: none;
            color: #ccc;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            padding: 1%;
            border-radius: 10px;
            border: none;
        }

        .header button:hover {
            background-color: #f1f1f136;
            color: #fff;
        }

        .weekdays,

        #days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            padding: 1%;
            text-align: center;
            color: #000000;
        }

        .weekdays div {
            font-weight: bold;
            padding: 15%;
            color: #000000;
        }

        #days div {
            padding: 30%;
            cursor: pointer;
            border-radius: 10%;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }

        #days div.active {
            background-color: #ff8888;
            color: #fff;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <!-- Bootstrap e ícones -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="css/styles.css" rel="stylesheet">
</head>

<body>
    <div class="container-pai">
        <!-- Topo com botões e usuário -->
        <div class="top-bar d-flex justify-content-between align-items-center mb-3">

            <!-- Botões principais -->
            <!-- Funciona o btn da tela atual fica azul e sem ação, enquanto q os outros, ao clicar, passam como paramentroa nova tela para abrir -->
            <div class="d-flex gap-2 flex-grow-1">
                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-gerenciar.html'">Gerenciar Usuários</button>

                <button type="button" class="btn btn-selected rounded-pill flex-fill">Definir Agenda</button>

                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-alunos.html'">Tabela Alunos</button>

                <button type="button" class="btn btn-primary rounded-pill flex-fill"
                    onclick="window.location.href='coord-banca.html'">Tabela Banca</button>
            </div>

            <script>
                // Selecionar botão, com parametro de sua respectiva tela
                function selecionarBotao(botaoClicado) {
                    document.querySelectorAll('.top-bar .btn.rounded-pill').forEach(btn => {
                        btn.classList.replace('btn-selected', 'btn-primary');
                    });
                    botaoClicado.classList.replace('btn-primary', 'btn-selected');
                }
            </script>

            <!-- Calendário -->
            <div class="ms-2 position-relative">
                <input type="text" id="datepicker" class="form-control d-none">
                <button type="button" class="btn btn-primary rounded-circle" id="calendarBtn">
                    <i class="bi bi-calendar-event"></i>
                </button>
            </div>

            <!-- Usuário -->
            <div class="ms-3">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle d-flex align-items-center gap-2" type="button"
                        id="usuarioDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span id="nome-usuario">Carregando...</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="usuarioDropdown">
                        <li><a class="dropdown-item" href="#">Perfil</a></li>
                        <li><a class="dropdown-item" href="#">Configurações</a></li>
                        <li><a class="dropdown-item" href="#">Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Conteúdo principal -->
        <div id="conteudo" class="row">
            <table id="rastreador-tarefas" class="table table-bordered text-center align-middle">
                <thead>
                    <tr>
                        <th colspan="4" class="text-white text-start fs-5 bg-primary">Rastreador de Tarefas</th>
                    </tr>
                    <tr class="bg-info text-dark">
                        <th style="width: 35%;">Aluno</th>
                        <th style="width: 25%;">Orientador</th>
                        <th style="width: 20%;">Status</th>
                        <th style="width: 20%;">Banca</th>
                    </tr>
                </thead>
                <tbody id="tabela-agenda-body">
                    <tr>
                        <td class="nome-tarefa">1. Entrega da Proposta</td>
                        <td><input type="date" class="form-control" name="1"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">2. Retorno da Proposta</td>
                        <td><input type="date" class="form-control" name="2"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">3. Entrega da Reelaboração</td>
                        <td><input type="date" class="form-control" name="3"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">4. Retorno da Reelaboração</td>
                        <td><input type="date" class="form-control" name="4"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">5. Entrega do TCC I</td>
                        <td><input type="date" class="form-control" name="5"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">6. Retorno da do TCC I</td>
                        <td><input type="date" class="form-control" name="6"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">7. Entrega do TCC II</td>
                        <td><input type="date" class="form-control" name="7"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">8. Retorno do TCC II</td>
                        <td><input type="date" class="form-control" name="8"></td>
                    </tr>
                    <tr>
                        <td class="nome-tarefa">9. Entrega da Proposta</td>
                        <td><input type="date" class="form-control" name="9"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="calendar tabela-agenda-body" class="col-md-8">
            <div class="header">
                <button id="prev-month">&lt;</button>
                <div id="month-year"></div>
                <button id="next-month">&gt;</button>
            </div>

            <div class="weekdays">
                <div>Dom</div>
                <div>Seg</div>
                <div>Ter</div>
                <div>Qua</div>
                <div>Qui</div>
                <div>Sex</div>
                <div>Sáb</div>
            </div>

            <div id="days"></div>
        </div>
    </div>

    <div class="modal fade" id="modal-gerenciar-banca" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalLabel">Gerenciar Banca</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="id-trabalho-modal">

                    <h6>Membros da Banca</h6>
                    <div id="lista-professores-modal" class="mb-3 border p-2 rounded"
                        style="max-height: 150px; overflow-y: auto;">
                        Carregando professores...
                    </div>

                    <h6>Agendamento</h6>
                    <div class="mb-3">
                        <label for="data-hora-banca" class="form-label">Data e Hora</label>
                        <input type="datetime-local" class="form-control" id="data-hora-banca">
                    </div>
                    <div class="mb-3">
                        <label for="local-banca" class="form-label">Local (Sala ou Link)</label>
                        <input type="text" class="form-control" id="local-banca"
                            placeholder="Ex: Sala 302 ou Link do Meet">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-banca">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        // Calendário
        const fp = flatpickr("#datepicker", {
            onChange: (dates, dateStr) => console.log("Data selecionada:", dateStr),
            positionElement: document.getElementById('calendarBtn'),
            allowInput: true
        });
        document.getElementById('calendarBtn').addEventListener('click', () => fp.open());
    </script>

    <script>

        let bancaModal = null;
        let idTrabalhoAtual = null;

        document.addEventListener('DOMContentLoaded', () => {

            const modalEl = document.getElementById('modal-gerenciar-banca');
            if (modalEl) {
                bancaModal = new bootstrap.Modal(modalEl);
            }

            carregarNomeUsuario();
            carregarDadosAgenda();

            document.getElementById('btn-salvar-banca').addEventListener('click', salvarBanca);
        });

        function carregarNomeUsuario() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo'));
            const nomeUsuarioEl = document.getElementById('nome-usuario');

            if (userInfo && userInfo.nome) {
                nomeUsuarioEl.textContent = userInfo.nome;
            } else {
                nomeUsuarioEl.textContent = 'Usuário';
            }
        }

        async function carregarDadosAgenda() {
            const token = localStorage.getItem('authToken');
            const tbody = document.getElementById('tabela-agenda-body');

            tbody.innerHTML = '<tr><td colspan="4">Carregando dados...</td></tr>';

            // verificação de segurança: se não há token, redireciona para o login
            if (!token) {
                window.location.href = 'index.html'
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/coordenador/agenda', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // se token for inválido ou expirado
                if (!response.ok) {
                    // limpa o armazenamento e redireciona para o login
                    localStorage.clear();
                    window.location.href = 'index.html'
                    return;
                }

                const trabalhos = await response.json();

                // limpa a mensagem de "Carregando..."
                tbody.innerHTML = '';

                if (trabalhos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Nenhum trabalho encontrado.</td></tr>';
                } else {
                    trabalhos.forEach(trabalho => {
                        const row = document.createElement('tr');

                        let infoBanca = '';
                        if (trabalho.membros_banca) {
                            const dataFormatada = new Date(trabalho.data_hora).toLocaleDateString('pt-BR', { timeZone: 'UTC' });

                            infoBanca = `
                                <small>
                                    <strong>Membros:</strong> ${trabalho.membros_banca}<br>
                                    <strong>Data:</strong> ${dataFormatada}<br>
                                    <strong>Local:</strong> ${trabalho.local}
                                </small>
                            `;
                        } else {
                            infoBanca = '<span class="text-muted">Não definida</span>';
                        }

                        row.innerHTML = `
                            <td>${trabalho.nome_aluno}</td>
                            <td>${trabalho.nome_orientador}</td>
                            <td><span class="badge bg-primary">${trabalho.status}</span></td>
                            <td>
                                ${infoBanca}
                                <hr class="my-1">
                                <button class="btn btn-info btn-sm gerenciar-banca-btn" data-id="${trabalho.id_trabalho}">
                                    <i class="bi bi-pencil-square"></i> Gerenciar
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.querySelectorAll('.gerenciar-banca-btn').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        const idTrabalho = event.currentTarget.dataset.id;
                        abrirModalGerenciarBanca(idTrabalho);
                    });
                });

            } catch (error) {
                console.error("Erro ao buscar dados da agenda:", error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Falha ao carregar os dados. Verifique a conexão com o servidor.</td></tr>'
            }
        }

        async function abrirModalGerenciarBanca(idTrabalho) {
            idTrabalhoAtual = idTrabalho; // salva o ID do trabalho que está sendo editado
            const token = localStorage.getItem('authToken');
            const listaProfessoresDiv = document.getElementById('lista-professores-modal');
            listaProfessoresDiv.innerHTML = 'Carregando professores...';

            try {
                // busca a lista de todos os professores para preencher os checkboxes
                const response = await fetch('http://localhost:3000/professores', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { throw new Error('Falha ao buscar professores'); }

                const professores = await response.json();
                listaProfessoresDiv.innerHTML = '';

                professores.forEach(prof => {
                    listaProfessoresDiv.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${prof.id_usuario}" id="prof-${prof.id_usuario}">
                            <label class="form-check-label" for="prof-${prof.id_usuario}">
                                ${prof.nome}
                            </label>
                        </div>
                    `;
                });

                bancaModal.show();

            } catch (error) {
                listaProfessoresDiv.innerHTML = '<span class="text-danger">Erro ao carregar professores.</span>';
            }
        }

        async function salvarBanca() {
            const token = localStorage.getItem('authToken');
            const data_hora = document.getElementById('data-hora-banca').value;
            const local = document.getElementById('local-banca').value;

            const membrosSelecionados = [];
            document.querySelectorAll('#lista-professores-modal input[type="checkbox"]:checked').forEach(checkbox => {
                membrosSelecionados.push(checkbox.value);
            });

            if (!data_hora || !local || membrosSelecionados.length === 0) {
                alert('Por favor, preencha a data/hora, o local e selecione pelo menos um membro para a banca.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/coordenador/trabalhos/${idTrabalhoAtual}/definir-banca`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data_hora: data_hora,
                        local: local,
                        membros: membrosSelecionados
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'Erro ao salvar a banca.');
                }

                alert('Banca definida com sucesso!');
                bancaModal.hide();
                carregarDadosAgenda(); // recarrega a tabela principal com os novos dados

            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('month-year');
            const daysContainer = document.getElementById('days');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');

            let currentDate = new Date();

            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                monthYear.textContent = `${date.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
                daysContainer.innerHTML = '';

                for (let i = 0; i < firstDayOfMonth; i++) {
                    daysContainer.innerHTML += '<div></div>';
                }

                for (let i = 1; i <= lastDateOfMonth; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.textContent = i;
                    dayElement.setAttribute('data-day', i);

                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayElement.classList.add('active');
                    }

                    dayElement.style.display = 'flex';
                    dayElement.style.flexDirection = 'column';
                    dayElement.style.alignItems = 'center';

                    const dayOfWeek = new Date(year, month, i).getDay();

                    if (dayOfWeek === today.getDay()) {
                        dayElement.classList.add('highlight');
                    }

                    daysContainer.appendChild(dayElement);
                }

                adicionarTagsNoCalendario();
            }

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate);
            });

            // Inicializa o calendário só depois que o DOM existir
            renderCalendar(currentDate);

            function adicionarTagsNoCalendario() {
                document.querySelectorAll('.tag-tarefa').forEach(tag => tag.remove());

                const mesDoCalendario = currentDate.getMonth();
                const anoDoCalendario = currentDate.getFullYear();
                const linhasDeTarefa = document.querySelectorAll('#rastreador-tarefas tbody tr');

                linhasDeTarefa.forEach(linha => {
                    const nomeTarefaCompleto = linha.querySelector('.nome-tarefa').textContent.trim();
                    const inputData = linha.querySelector('input[type="date"]').value;

                    if (inputData) {
                        const data = new Date(inputData + 'T00:00:00');
                        const dia = data.getDate();
                        const mes = data.getMonth();
                        const ano = data.getFullYear();

                        const indexPonto = nomeTarefaCompleto.indexOf('.');
                        const numeroDaTarefa = nomeTarefaCompleto.substring(0, indexPonto);

                        if (mes === mesDoCalendario && ano === anoDoCalendario) {
                            const diaCell = document.querySelector(`#days div[data-day="${dia}"]`);

                            if (diaCell) {
                                const tag = document.createElement('div');
                                tag.classList.add('tag-tarefa');
                                tag.textContent = numeroDaTarefa;
                                diaCell.appendChild(tag);
                            }
                        }
                    }
                });
            }

            const inputsDeData = document.querySelectorAll('#rastreador-tarefas input[type="date"]');
            inputsDeData.forEach(input => {
                input.addEventListener('change', () => {
                    adicionarTagsNoCalendario();
                });
            });
        });
    </script>
</body>

</html>